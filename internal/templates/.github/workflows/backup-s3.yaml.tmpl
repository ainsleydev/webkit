name: Backup Bucket

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # Runs daily at 3 AM

jobs:
  backup-bucket:
    name: Backup DigitalOcean Spaces to Backblaze B2
    runs-on: ubuntu-latest
    timeout-minutes: 60 # 1 Hour
    env:
      BACKUP_PATH: '/backups/bucket/'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: Configure rclone for DigitalOcean Spaces
        run: |
          rclone config create do_spaces s3 \
            env_auth true \
            provider DigitalOcean \
            access_key_id ${{ secrets.DO_SPACES_ACCESS_KEY }} \
            secret_access_key ${{ secrets.DO_SPACES_SECRET_KEY }} \
            region ${{ secrets.DO_SPACES_REGION }} \
            endpoint https://${{ secrets.DO_SPACES_REGION }}.digitaloceanspaces.com

      - name: Configure rclone for Backblaze B2
        run: |
          rclone config create b2_backup b2 \
            account ${{ secrets.B2_APPLICATION_KEY_ID }} \
            key ${{ secrets.B2_APPLICATION_KEY }}

      - name: Sync Bucket to B2
        run: |
          # Sync entire DO Spaces bucket to B2, deleting extraneous files
          rclone sync do_spaces:${{ secrets.DO_SPACES_BUCKET }} b2_backup:${{ secrets.B2_BUCKET_NAME }} \
            --progress --transfers=16 --checkers=16 --delete-excluded

      - name: Verify Backup
        run: |
          echo "Backup completed successfully!"
