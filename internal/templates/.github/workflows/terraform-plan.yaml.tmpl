name: Terraform Plan

on:
  pull_request:
    branches: [main, staging]
    paths:
      - 'app.json'
      - '.github/workflows/terraform-*.yml'

env:
  WEBKIT_VERSION: 'v1.0.0'  # This will be generated by webkit CLI
  WEBKIT_REPO: 'https://github.com/ainsleydev/webkit'
  PROJECT_NAME: 'my-website'  # This will be generated from app.json
  TF_VERSION: '1.13.0'

jobs:
  plan:
    name: Plan Infrastructure Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    with:
      project_name: {{ .Project.Name }}
      environment: "production"
      resources: '{{ .Resources | mustToJson }}'
      apps: '{{ .Apps | mustToJson }}'

    steps:
      - name: Checkout Project Repository
        uses: actions/checkout@v4

      - name: Clone WebKit Infrastructure Repository
        run: |
          git clone --depth 1 --branch ${{ env.WEBKIT_VERSION }} \
            ${{ env.WEBKIT_REPO }} /tmp/webkit

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        working-directory: /tmp/webkit
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        working-directory: /tmp/webkit
        env:
          DIGITALOCEAN_TOKEN: ${{ secret "DIGITALOCEAN_TOKEN" }}
          B2_APPLICATION_KEY_ID: ${{ secret "ORG_PROD_B2_APPLICATION_KEY_ID" }}
          B2_APPLICATION_KEY: ${{ secret "ORG_PROD_B2_APPLICATION_KEY" }}
          TURSO_TOKEN: ${{ secret "ORG_TURSO_TOKEN" }}
        run: |
          terraform init \
            -backend-config="bucket=webkit-terraform-state" \
            -backend-config="key=projects/TODO/terraform.tfstate" \
            -backend-config="region=us-west-000" \
            -backend-config="endpoint=https://s3.us-west-000.backblazeb2.com" \
            -backend-config="access_key=${{ secret "ORG_PROD_B2_APPLICATION_KEY_ID" }}" \
            -backend-config="secret_key=${{ secret "ORG_PROD_B2_APPLICATION_KEY" }}" \
            -backend-config="skip_credentials_validation=true" \
            -backend-config="skip_metadata_api_check=true"

      - name: Terraform Validate
        working-directory: /tmp/webkit
        run: terraform validate

      - name: Terraform Plan
        working-directory: /tmp/webkit-infra
        env:
          DIGITALOCEAN_TOKEN: ${{ secret "DIGITALOCEAN_TOKEN" }}
          B2_APPLICATION_KEY_ID: ${{ secret "B2_APPLICATION_KEY_ID" }}
          B2_APPLICATION_KEY: ${{ secret "B2_APPLICATION_KEY" }}
          TURSO_TOKEN: ${{ secret "ORG_TURSO_TOKEN" }}
        run: |
          terraform plan \
            -out=tfplan \
            -no-color \
            | tee plan-output.txt

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: /tmp/webkit-infra/tfplan
          retention-days: 5

      - name: Upload Plan Output
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-output
          path: /tmp/webkit-infra/plan-output.txt
          retention-days: 5
