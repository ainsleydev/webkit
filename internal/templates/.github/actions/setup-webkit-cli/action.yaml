name: 'Setup WebKit CLI'
description: 'Downloads and installs the WebKit CLI from workflow artifacts'

inputs:
  app-json-path:
    description: 'Path to app.json file'
    required: false
    default: 'app.json'

outputs:
  version:
    description: 'The WebKit version that was installed'
    value: ${{ steps.version.outputs.version }}
  cli-path:
    description: 'Path to the webkit CLI binary'
    value: ${{ steps.download.outputs.cli-path }}

runs:
  using: 'composite'
  steps:
    - name: Read WebKit Version
      id: version
      shell: bash
      run: |
        WEBKIT_VERSION=$(jq -r '.webkit_version // "latest"' ${{ inputs.app-json-path }})
        echo "version=$WEBKIT_VERSION" >> $GITHUB_OUTPUT
        echo "Detected WebKit version: $WEBKIT_VERSION"

    - name: Download WebKit Release Asset
      id: setup
      uses: robinraju/release-downloader@v1
      with:
        repository: 'ainsleydev/webkit'
        tag: ${{ steps.version.outputs.version }}
        fileName: 'webkit_linux_x86_64.tar.gz'
        out-file-path: '/tmp/webkit-install'
        extract: true

    - name: Set CLI Path
      shell: bash
      run: |
        CLI_PATH="/tmp/webkit-install/webkit"
        if [ ! -f "$CLI_PATH" ]; then
          echo "Error: WebKit CLI not found in downloaded artifact"
          exit 1
        fi
        chmod +x "$CLI_PATH"
        echo "cli-path=$CLI_PATH" >> $GITHUB_OUTPUT
        echo "WebKit CLI ready at $CLI_PATH"

    - name: Verify WebKit CLI
      shell: bash
      run: |
        $CLI_PATH version || echo "Warning: Could not verify WebKit version"
