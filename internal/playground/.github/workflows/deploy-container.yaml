# Code generated by webkit; DO NOT EDIT.
name: Deploy Container

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application to deploy'
        required: true
        type: string
      image_tag:
        description: 'Image tag to deploy (e.g., sha-abc123 or latest)'
        required: false
        type: string
        default: 'latest'
    secrets:
      REPO_DO_ACCESS_TOKEN:
        required: false
      ORG_DO_ACCESS_TOKEN:
        required: false

permissions:
  contents: read
  packages: read

# Prevent concurrent deployments for the same app.
concurrency:
  group: deploy-do-container-${{ github.event.inputs.app_name || inputs.app_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Deploy Web to DigitalOcean App Platform
  deploy-web:
    runs-on: ubuntu-latest
    if: github.event.inputs.app_name == 'web' || inputs.app_name == 'web'
    environment:
      name: production-web
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Set DO Token
        id: do-token
        shell: bash
        run: |
          # Use repo-level token if available, otherwise use org-level token.
          if [ -n "${{ secrets.REPO_DO_ACCESS_TOKEN }}" ]; then
            echo "token=${{ secrets.REPO_DO_ACCESS_TOKEN }}" >> $GITHUB_OUTPUT
            echo "Using repository-level DigitalOcean token"
          elif [ -n "${{ secrets.ORG_DO_ACCESS_TOKEN }}" ]; then
            echo "token=${{ secrets.ORG_DO_ACCESS_TOKEN }}" >> $GITHUB_OUTPUT
            echo "Using organization-level DigitalOcean token"
          else
            echo "Error: No DigitalOcean access token available"
            exit 1
          fi

      - name: Deploy Web to DigitalOcean App Platform
        shell: bash
        env:
          DO_API_TOKEN: ${{ steps.do-token.outputs.token }}
          APP_ID: ${{ secrets.DO_APP_WEB_ID }}
        run: |
          # Get the app ID for web.
          echo "Deploying web with image tag ${{ inputs.image_tag }}"

          # Trigger deployment for the app.
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DO_API_TOKEN" \
            -d '{
              "force_build": false,
              "image": {
                "registry_type": "GHCR",
                "registry": "ghcr.io",
                "repository": "${{ github.repository }}/${{ github.event.repository.name }}-web",
                "tag": "${{ inputs.image_tag }}"
              }
            }' \
            "https://api.digitalocean.com/v2/apps/$APP_ID/deployments"

          echo "Deployment triggered for web"
