# Code generated by webkit; DO NOT EDIT.
name: Server Maintenance

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0' # Every Sunday at 03:00 UTC

jobs:
  maintenance-vm-cms:
    runs-on: ubuntu-latest
    environment:
      name: production-cms
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Read WebKit Version
        id: read_version
        run: |
          WEBKIT_VERSION=$(jq -r '.webkit_version // "latest"' "app.json")
          echo "version=$WEBKIT_VERSION" >> $GITHUB_OUTPUT
          echo "Detected WebKit version: $WEBKIT_VERSION"

      - name: Checkout WebKit Repository
        uses: actions/checkout@v5
        with:
          repository: 'ainsleydev/webkit'
          ref: ${{ steps.read_version.outputs.version }}
          path: '.webkit-repo'

      - name: Copy Ansible Files
        run: |
          cp -r .webkit-repo/platform/ansible ./
          echo "Copied ansible files from WebKit ${{ steps.read_version.outputs.version }}"

      - name: Run Ansible Maintenance Playbook for CMS
        uses: dawidd6/action-ansible-playbook@v4
        with:
          playbook: playbooks/maintenance.yaml
          directory: ansible
          key: ${{ secrets.TF_PROD_CMS_SSH_PRIVATE_KEY }}
          inventory: |
            [all]
            cms ansible_host=${{ secrets.TF_PROD_CMS_IP_ADDRESS }} ansible_user=${{ secrets.TF_PROD_CMS_SERVER_USER }}
          options: |
            -e app_name=cms
            -e domain=cms.my-website.com
            -e admin_email=hello@ainsley.dev
            -v

      - name: Notify Slack of Maintenance Failure
        if: failure()
        uses: ./.github/actions/slack-notify
        with:
          title: 'Server Maintenance Failed - CMS'
          message: 'Weekly maintenance tasks failed for CMS. Server updates may not have been applied.'
          status: 'failure'
          commit_sha: ${{ github.sha }}
          slack_bot_token: ${{ secrets.ORG_SLACK_BOT_TOKEN }}
          channel_id: ${{ secrets.TF_SLACK_CHANNEL_ID }}
