# Code generated by webkit; DO NOT EDIT.
name: Deploy VM App

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application to deploy'
        required: true
        type: choice
        options:
          - cms
      image_tag:
        description: 'Image tag to deploy (e.g., sha-abc123 or latest)'
        required: false
        type: string
        default: 'latest'
      webkit_version:
        description: 'WebKit version (defaults to version in app.json)'
        required: false
        type: string
  workflow_call:
    inputs:
      app_name:
        description: 'Application to deploy'
        required: true
        type: string
      image_tag:
        description: 'Image tag to deploy (e.g., sha-abc123 or latest)'
        required: false
        type: string
        default: 'latest'
      webkit_version:
        description: 'WebKit version'
        required: true
        type: string
    secrets:
      ORG_AGE_SECRET:
        required: true
      ORG_DO_ACCESS_TOKEN:
        required: true
      ORG_DO_SPACES_ACCESS_KEY:
        required: true
      ORG_DO_SPACES_SECRET_KEY:
        required: true
      ORG_BACK_BLAZE_TF_BUCKET:
        required: true
      ORG_BACK_BLAZE_KEY_ID:
        required: true
      ORG_BACK_BLAZE_APPLICATION_KEY:
        required: true
      ORG_GITHUB_TOKEN:
        required: true
      ORG_GITHUB_TOKEN_CLASSIC:
        required: true
      GITHUB_TOKEN:
        required: false

permissions:
  contents: read
  packages: read

# Prevent concurrent deployments.
concurrency:
  group: deploy-vm-${{ github.event.inputs.app_name }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_VERSION: '1.13.0'

jobs:
  # Setup WebKit CLI
  setup-webkit:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Read WebKit Version
        id: version
        shell: bash
        run: |
          if [ -n "${{ inputs.webkit_version }}" ]; then
            WEBKIT_VERSION="${{ inputs.webkit_version }}"
          else
            WEBKIT_VERSION=$(jq -r '.webkit_version // "latest"' "app.json")
          fi
          echo "version=$WEBKIT_VERSION" >> $GITHUB_OUTPUT
          echo "Detected WebKit version: $WEBKIT_VERSION"

      - name: Download WebKit Release Asset
        id: setup
        uses: robinraju/release-downloader@v1
        with:
          repository: 'ainsleydev/webkit'
          tag: ${{ steps.version.outputs.version }}
          fileName: 'webkit_linux_x86_64.tar.gz'
          extract: true

      - name: Upload WebKit CLI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: webkit
          path: webkit
          if-no-files-found: error
  # Deploy CMS to DigitalOcean VM
  deploy-cms:
    runs-on: ubuntu-latest
    needs: [setup-webkit]
    if: ${{ github.event.inputs.app_name }} == 'cms'
    environment:
      name: production-cms
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Checkout WebKit Repository
        uses: actions/checkout@v5
        with:
          repository: 'ainsleydev/webkit'
          ref: ${{ needs.setup-webkit.outputs.version }}
          path: '.webkit-repo'

      - name: Copy Ansible Files
        run: |
          cp -r .webkit-repo/platform/ansible ./
          echo "Copied ansible files from WebKit ${{ needs.setup-webkit.outputs.version }}"

      - name: Download WebKit CLI Artifact
        uses: actions/download-artifact@v4
        with:
          name: webkit
          path: ./

      - name: Make WebKit executable
        run: chmod +x ./webkit

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Install SOPS
        run: |
          curl -LO https://github.com/getsops/sops/releases/download/v3.11.0/sops-v3.11.0.linux.amd64
          sudo mv sops-v3.11.0.linux.amd64 /usr/local/bin/sops
          sudo chmod +x /usr/local/bin/sops
          sops --version

      - name: Generate production env file for CMS
        env:
          SOPS_AGE_KEY: ${{ secrets.ORG_AGE_SECRET }}
          DO_API_KEY: ${{ secrets.ORG_DO_ACCESS_TOKEN }}
          DO_SPACES_ACCESS_KEY: ${{ secrets.ORG_DO_SPACES_ACCESS_KEY }}
          DO_SPACES_SECRET_KEY: ${{ secrets.ORG_DO_SPACES_SECRET_KEY }}
          BACK_BLAZE_BUCKET: ${{ secrets.ORG_BACK_BLAZE_TF_BUCKET }}
          BACK_BLAZE_KEY_ID: ${{ secrets.ORG_BACK_BLAZE_KEY_ID }}
          BACK_BLAZE_APPLICATION_KEY: ${{ secrets.ORG_BACK_BLAZE_APPLICATION_KEY }}
          GITHUB_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          GITHUB_TOKEN_CLASSIC: ${{ secrets.ORG_GITHUB_TOKEN_CLASSIC }}
        run: |
          ./webkit env generate \
            --app cms \
            --environment production \
            --output /tmp/cms.env
          echo "Generated .env file for cms"

      - name: Verify env file was generated
        run: |
          if [ ! -f /tmp/cms.env ]; then
            echo "ERROR: Environment file was not generated at /tmp/cms.env"
            exit 1
          fi
          echo "✓ Environment file exists at /tmp/cms.env"
          echo "✓ Environment file size: $(wc -l < /tmp/cms.env) lines"
          echo "✓ Environment file contains $(grep -c '=' /tmp/cms.env || echo 0) variables"

      - name: Run Ansible playbook for CMS
        uses: dawidd6/action-ansible-playbook@v4
        with:
          playbook: playbooks/server.yaml
          directory: ansible
          key: ${{ secrets.TF_PROD_CMS_SSH_PRIVATE_KEY }}
          inventory: |
            [all]
            cms ansible_host=${{ secrets.TF_PROD_CMS_IP_ADDRESS }} ansible_user=${{ secrets.TF_PROD_CMS_SERVER_USER }}
          options: |
            -e webkit_version=${{ needs.setup-webkit.outputs.version }}
            -e age_secret_key=${{ secrets.ORG_AGE_SECRET }}
            -e app_name=cms
            -e env_name=production
            -e git_sha=${{ github.event.inputs.image_tag }}
            -e github_user=${{ github.repository_owner }}
            -e github_token=${{ secrets.GITHUB_TOKEN }}
            -e domain=
            -e docker_image=${{ github.event.repository.name }}-cms
            -e docker_image_tag=${{ github.event.inputs.image_tag }}
            -e docker_port=3000
            -e enable_https=true
            -e admin_email=hello@ainsley.dev
            -e env_file_source_path=/tmp/cms.env
            -v
