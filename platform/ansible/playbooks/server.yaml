- name: Deploy server with Docker and Nginx (Ansible-native)
  hosts: all
  become: true
  vars:
    # All variables below are required and should be passed via -e flags
    # domain: from app.PrimaryDomain
    # github_user: repository owner
    # docker_image: repo-name-app-name (e.g., my-repo-cms)
    # docker_image_tag: 'sha-abc123'
    # docker_port: from app.Build.Port
    # app_name: from app.Name
    # env_name: environment name (development, staging, production)
    # age_secret_key: AGE private key for SOPS decryption
    # enable_https: from app.Infra.Config.https (defaults to true)
    # admin_email: from app.Infra.Config.admin_email (defaults to hello@ainsley.dev)
    # Path where env file will be generated
    env_file_path: '/opt/{{ app_name }}/.env'
    # Configuration directory for webkit (must match role default)
    webkit_config_dir: '/etc/webkit'

  # TODO (BUG):
  # If the server updates it's packages then reboots,
  # nginx will display a 502 whilst it updates Docker Swam again.
  pre_tasks:
    - name: Update apt package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist
      register: upgrade_result

    - name: Ensure python3-pip is installed
      apt:
        name: python3-pip
        state: present

    - name: Reboot if kernel updated
      reboot:
        msg: 'Reboot initiated by Ansible due to package upgrade'
        reboot_timeout: 600
      when:
        - upgrade_result.changed
        - skip_reboot is not defined or not skip_reboot

  roles:
    - fail2ban
    - tools
    - docker
    - webkit
    - nginx
    - ufw

  tasks:
    - name: Login to GitHub Container Registry
      community.docker.docker_login:
        registry_url: ghcr.io
        username: '{{ github_user }}'
        password: '{{ github_token }}'

    - name: Ensure Docker Swarm is initialized
      community.docker.docker_swarm:
        state: present
        advertise_addr: '{{ ansible_default_ipv4.address }}'

    - name: Create app directory for env file
      file:
        path: '/opt/{{ app_name }}'
        state: directory
        mode: '0755'

    - name: Check if app.json exists in webkit config
      stat:
        path: '{{ webkit_config_dir }}/app.json'
      register: app_json_stat

    - name: Display app.json status
      debug:
        msg: 'app.json exists: {{ app_json_stat.stat.exists }}, path: {{ webkit_config_dir }}/app.json'

    - name: Check if secrets directory exists
      stat:
        path: '{{ webkit_config_dir }}/resources/secrets'
      register: secrets_dir_stat

    - name: Display secrets directory status
      debug:
        msg: 'Secrets directory exists: {{ secrets_dir_stat.stat.exists }}, path: {{ webkit_config_dir }}/resources/secrets'

    - name: Generate production env file using webkit
      command: >
        /usr/local/bin/webkit env generate
        --app {{ app_name }}
        --environment {{ env_name }}
        --output {{ env_file_path }}
      args:
        chdir: /etc/webkit
      environment:
        SOPS_AGE_KEY: '{{ age_secret_key }}'
      register: env_generate_result
      failed_when: env_generate_result.rc != 0
      no_log: true

    - name: Verify env file was created
      stat:
        path: '{{ env_file_path }}'
      register: env_file_stat

    - name: Display env generation error if file wasn't created
      debug:
        msg: 'WARNING: webkit env generate completed but .env file was not created at {{ env_file_path }}'
      when: not env_file_stat.stat.exists

    - name: Fail if env file doesn't exist
      fail:
        msg: 'Environment file was not created at {{ env_file_path }}. Check that app.json and secrets exist in /etc/webkit'
      when: not env_file_stat.exists

    - name: Debug image tag
      debug:
        msg: 'Deploying image: ghcr.io/{{ github_user }}/{{ docker_image }}:{{ docker_image_tag }}'

    - name: Deploy/update Docker Swarm service
      community.docker.docker_swarm_service:
        name: '{{ docker_image }}'
        image: 'ghcr.io/{{ github_user }}/{{ docker_image }}:{{ docker_image_tag }}'
        networks:
          - name: host
        env_files:
          - '{{ env_file_path }}'
        mode: replicated
        replicas: 1
        force_update: true # Force update even if no changes require it.
        update_config:
          parallelism: 1
          delay: 10s
          failure_action: rollback
        restart_config:
          condition: on-failure
          delay: 5s
          max_attempts: 3
        publish:
          - target_port: '{{ docker_port | int }}'
            published_port: '{{ docker_port | int }}'
            protocol: tcp
            mode: host

    - name: Wait for the app to respond on localhost
      uri:
        url: 'http://localhost:{{ docker_port }}'
        method: GET
        status_code: 200
      register: curl_result
      retries: 120
      delay: 5
      until: curl_result.status == 200
      ignore_errors: yes

    - name: Run Certbot to get HTTPS certificate
      include_role:
        name: certbot
      when: enable_https | default(true) | bool

    - name: Deploy SSL Nginx configuration after certificates are obtained
      include_role:
        name: nginx
      vars:
        skip_install: true
      when: enable_https | default(true) | bool
