name: Update WebKit Repos

on:
  workflow_dispatch:
    inputs:
      webkit_version:
        description: 'WebKit version to update to (e.g., 0.0.41)'
        required: false
        type: string
  workflow_run:
    workflows: ['Release']
    types:
      - completed

permissions:
  contents: read

jobs:
  update-repos:
    runs-on: ubuntu-latest
    # Only run if triggered manually or if the Release workflow succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Create GitHub App token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: 2161597
          private-key: ${{ secrets.ORG_GITHUB_APP_PRIVATE_KEY }}
          owner: ainsleydev

      - name: Get WebKit version
        id: get_version
        run: |
          if [ -n "${{ inputs.webkit_version }}" ]; then
            # Manual trigger with specific version
            VERSION="${{ inputs.webkit_version }}"
          else
            # Get latest release version from GitHub
            VERSION=$(gh release view --json tagName --jq '.tagName' | sed 's/^v//')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using WebKit version: $VERSION"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Find repos with webkit_version
        id: find_repos
        run: |
          echo "Fetching all repositories in ainsleydev org..."

          # Get all repos in the org (works with private repos)
          ALL_REPOS=$(gh repo list ainsleydev --limit 1000 --json nameWithOwner --jq '.[].nameWithOwner')

          REPOS_WITH_WEBKIT=""

          # Check each repo for app.json with webkit_version
          for REPO in $ALL_REPOS; do
            echo "Checking $REPO..."

            # Try to fetch app.json from the repo
            if CONTENT=$(gh api "repos/$REPO/contents/app.json" --jq '.content' 2>/dev/null); then
              # Decode base64 content and check for webkit_version field
              if echo "$CONTENT" | base64 -d | jq -e '.webkit_version' >/dev/null 2>&1; then
                echo "  âœ“ Found webkit_version in $REPO"
                REPOS_WITH_WEBKIT="$REPOS_WITH_WEBKIT$REPO"$'\n'
              fi
            fi
          done

          if [ -z "$REPOS_WITH_WEBKIT" ]; then
            echo "No repositories found with webkit_version field"
            echo "repos=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found repositories with webkit_version:"
          echo "$REPOS_WITH_WEBKIT"

          # Convert to JSON array
          echo "$REPOS_WITH_WEBKIT" | jq -R -s -c 'split("\n") | map(select(length > 0))' > repos.json
          echo "repos=$(cat repos.json)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Update repositories
        if: steps.find_repos.outputs.repos != '[]'
        run: |
          go run ./cmd/update-webkit-repos \
            --version="${{ steps.get_version.outputs.version }}" \
            --repos='${{ steps.find_repos.outputs.repos }}'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
