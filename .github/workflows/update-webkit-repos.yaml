name: Update WebKit Repos

on:
  workflow_dispatch:
    inputs:
      webkit_version:
        description: 'WebKit version to update to (e.g., 0.0.41)'
        required: false
        type: string
  workflow_run:
    workflows: ['Release']
    types:
      - completed

permissions:
  contents: read

jobs:
  update-repos:
    runs-on: ubuntu-latest
    # Only run if triggered manually or if the Release workflow succeeded
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Create GitHub App token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: 2161597
          private-key: ${{ secrets.ORG_GITHUB_APP_PRIVATE_KEY }}
          owner: ainsleydev

      - name: Get WebKit version
        id: get_version
        run: |
          if [ -n "${{ inputs.webkit_version }}" ]; then
            # Manual trigger with specific version
            VERSION="${{ inputs.webkit_version }}"
          else
            # Get latest release version from GitHub
            VERSION=$(gh release view --json tagName --jq '.tagName' | sed 's/^v//')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using WebKit version: $VERSION"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Find repos with webkit_version
        id: find_repos
        run: |
          echo "Fetching all repositories in ainsleydev org..."

          # Get all repos in the org (works with private repos)
          ALL_REPOS=$(gh repo list ainsleydev --limit 1000 --json nameWithOwner --jq '.[].nameWithOwner')

          REPOS_WITH_WEBKIT=""

          # Check each repo for app.json with webkit_version
          for REPO in $ALL_REPOS; do
            echo "Checking $REPO..."

            # Try to fetch app.json from the repo
            if CONTENT=$(gh api "repos/$REPO/contents/app.json" --jq '.content' 2>/dev/null); then
              # Decode base64 content and check for webkit_version field
              if echo "$CONTENT" | base64 -d | jq -e '.webkit_version' >/dev/null 2>&1; then
                echo "  ✓ Found webkit_version in $REPO"
                REPOS_WITH_WEBKIT="$REPOS_WITH_WEBKIT$REPO"$'\n'
              fi
            fi
          done

          if [ -z "$REPOS_WITH_WEBKIT" ]; then
            echo "No repositories found with webkit_version field"
            echo "repos=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found repositories with webkit_version:"
          echo "$REPOS_WITH_WEBKIT"

          # Convert to JSON array
          echo "$REPOS_WITH_WEBKIT" | jq -R -s -c 'split("\n") | map(select(length > 0))' > repos.json
          echo "repos=$(cat repos.json)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Update repositories
        if: steps.find_repos.outputs.repos != '[]'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          REPOS='${{ steps.find_repos.outputs.repos }}'

          echo "Updating repositories to WebKit v$VERSION"

          # Parse JSON array and iterate
          echo "$REPOS" | jq -r '.[]' | while read -r REPO; do
            echo "Processing $REPO..."

            # Clone the repository
            REPO_DIR=$(basename "$REPO")
            gh repo clone "$REPO" "$REPO_DIR" -- --depth=1

            cd "$REPO_DIR"

            # Configure git remote to use the GitHub App token for authentication
            git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"

            # Check if app.json exists and has webkit_version
            if [ ! -f "app.json" ]; then
              echo "  ⚠️  No app.json found, skipping..."
              cd ..
              rm -rf "$REPO_DIR"
              continue
            fi

            CURRENT_VERSION=$(jq -r '.webkit_version // empty' app.json | sed 's/^v//')

            if [ -z "$CURRENT_VERSION" ]; then
              echo "  ⚠️  No webkit_version field in app.json, skipping..."
              cd ..
              rm -rf "$REPO_DIR"
              continue
            fi

            if [ "$CURRENT_VERSION" = "$VERSION" ]; then
              echo "  ✓ Already on v$VERSION, skipping..."
              cd ..
              rm -rf "$REPO_DIR"
              continue
            fi

            echo "  Updating from v$CURRENT_VERSION to v$VERSION"

            # Define branch name
            BRANCH_NAME="chore/update-webkit-v$VERSION"

            # Close any stale webkit update PRs for older versions (always do this first)
            echo "  Checking for stale webkit update PRs..."
            STALE_PRS=$(gh pr list --repo "$REPO" --search "chore/update-webkit-v in:title" --state open --json number,headRefName --jq '.[] | select(.headRefName | startswith("chore/update-webkit-v")) | "\(.number):\(.headRefName)"')

            if [ -n "$STALE_PRS" ]; then
              while IFS=: read -r PR_NUM PR_BRANCH; do
                if [ "$PR_BRANCH" != "$BRANCH_NAME" ]; then
                  echo "  Closing stale PR #$PR_NUM (branch: $PR_BRANCH)..."
                  gh pr close "$PR_NUM" --repo "$REPO" --comment "Closing this PR as it's superseded by a newer WebKit version update to v$VERSION."

                  # Delete the stale remote branch
                  git push origin --delete "$PR_BRANCH" 2>/dev/null || true
                fi
              done <<< "$STALE_PRS"
            fi

            # Check if PR already exists for this exact version
            EXISTING_PR=$(gh pr list --repo "$REPO" --head "$BRANCH_NAME" --json number --jq '.[0].number' || echo "")

            if [ -n "$EXISTING_PR" ]; then
              echo "  ✓ PR #$EXISTING_PR already exists for v$VERSION (stale PRs cleaned up)"
              cd ..
              rm -rf "$REPO_DIR"
              continue
            fi

            # Create a new branch
            git checkout -b "$BRANCH_NAME"

            # Install webkit CLI at the target version
            echo "  Installing webkit v$VERSION..."
            WEBKIT_URL="https://github.com/ainsleydev/webkit/releases/download/v${VERSION}/webkit_${VERSION}_linux_amd64.tar.gz"
            curl -L "$WEBKIT_URL" | tar xz
            chmod +x webkit

            # Run webkit update to regenerate all files with the new version
            echo "  Running webkit update..."
            ./webkit update

            # Commit all changes (app.json and all regenerated files)
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "chore: Update WebKit to v$VERSION"

            # Delete remote branch if it exists (from a previous failed run)
            git push origin --delete "$BRANCH_NAME" 2>/dev/null || true

            # Push new branch
            git push origin "$BRANCH_NAME"

            # Create pull request
            PR_BODY="This automated PR updates the WebKit version from v$CURRENT_VERSION to v$VERSION.

            ## Testing
            - [ ] Review the generated files for any unexpected changes
            - [ ] Check for any breaking changes in the [release notes](https://github.com/ainsleydev/webkit/releases/tag/v$VERSION)
            - [ ] Test the application locally after merging"

            gh pr create \
              --repo "$REPO" \
              --head "$BRANCH_NAME" \
              --title "chore: Update WebKit to v$VERSION" \
              --body "$PR_BODY" \
              --base main

            echo "  ✓ Pull request created successfully"

            # Cleanup
            cd ..
            rm -rf "$REPO_DIR"

            echo ""
          done
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
